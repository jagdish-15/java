#!/usr/bin/env bash
set -eo pipefail

# Determine the base branch of the PR
BASE_BRANCH=${GITHUB_BASE_REF:-main}

# Fetch full history for proper diff
git fetch origin "$BASE_BRANCH"

# Compute merge base
MERGE_BASE=$(git merge-base HEAD origin/$BASE_BRANCH)

# Get changed files relative to merge base
changed_files=$(git diff --name-only "$MERGE_BASE" HEAD)

# Extract unique exercise directories
changed_exercises=$(echo "$changed_files" | \
  grep -E '^exercises/(practice|concept)/[^/]+/.+\.(java|json|gradle)$' | \
  cut -d/ -f1-3 | sort -u)

if [ -z "$changed_exercises" ]; then
  echo "No relevant exercises changed, skipping tests."
  exit 0
fi

# Source original verify_exercise script
source ./bin/test-with-test-runner

# Run verify_exercise for each changed exercise
for dir in $changed_exercises; do
  slug=$(basename "$dir")
  if [[ $dir == exercises/practice/* ]]; then
    echo "Checking $slug (practice)..."
    verify_exercise "$dir" "example" "practice"
  elif [[ $dir == exercises/concept/* ]]; then
    echo "Checking $slug (concept)..."
    verify_exercise "$dir" "exemplar" "concept"
  fi
done

exit ${exit_code:-0}
