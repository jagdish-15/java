#!/usr/bin/env bash
set -eo pipefail

BASE_BRANCH=${GITHUB_BASE_REF:-main}
git fetch origin "$BASE_BRANCH"
MERGE_BASE=$(git merge-base HEAD origin/$BASE_BRANCH)

changed_files=$(git diff --name-only "$MERGE_BASE" HEAD)

# If any gradle file changed, run the global script
if echo "$changed_files" | grep -q '\.gradle$'; then
  echo "Gradle build files changed, running full test suite..."
  ./exercises/gradlew -p exercises test
  exit 0
fi

# Otherwise, run tests only for changed exercises
changed_exercises=$(echo "$changed_files" | \
  grep -E '^exercises/(practice|concept)/[^/]+/.+\.java$' | \
  cut -d/ -f1-3 | sort -u)

if [ -z "$changed_exercises" ]; then
  echo "No relevant exercises changed, skipping tests."
  exit 0
fi

echo "Changed exercises detected:"
echo "$changed_exercises"
echo "----------------------------------------"

for dir in $changed_exercises; do
  slug=$(basename "$dir")

  echo "========================================"
  echo "=== Running tests for $slug ==="
  echo "========================================"

  if [[ $dir == exercises/practice/* ]]; then
    ./exercises/gradlew -p exercises ":practice:$slug:test"
  elif [[ $dir == exercises/concept/* ]]; then
    ./exercises/gradlew -p exercises ":concept:$slug:test"
  fi
done
